{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/aggregator/index.ts"],"names":[],"mappings":"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","sourcesContent":["import BN from \"bn.js\";\nimport type {\n  FeedEvalResponse,\n  Queue as SolanaQueue,\n} from \"@switchboard-xyz/on-demand\";\nimport {\n  getDefaultQueue,\n  getDefaultDevnetQueue,\n  ON_DEMAND_DEVNET_QUEUE,\n  ON_DEMAND_MAINNET_QUEUE,\n  CrossbarClient,\n  OracleJob,\n} from \"@switchboard-xyz/on-demand\";\nimport {\n  SwitchboardClient,\n  CommonOptions,\n  Queue,\n  aptosQueueCache,\n  solanaProgramCache,\n} from \"../index.js\";\nimport { SimpleTransaction, APTOS_COIN } from \"@aptos-labs/ts-sdk\";\nimport { bs58 } from \"@switchboard-xyz/common\";\n\nexport interface AggregatorInitParams extends CommonOptions {\n  name: string;\n  feedHash: string;\n  minSampleSize: number;\n  maxStalenessSeconds: number;\n  maxVariance: number;\n  minResponses: number;\n}\n\nexport interface AggregatorConfigParams extends CommonOptions {\n  aggregator: string;\n  name: string;\n  feedHash: string;\n  minSampleSize: number;\n  maxStalenessSeconds: number;\n  maxVariance: number;\n  minResponses: number;\n}\n\nexport interface AggregatorSetAuthorityParams extends CommonOptions {\n  aggregator: string;\n  newAuthority: string;\n}\n\nexport interface AggregatorConfigs {\n  feedHash: string;\n  maxVariance: number;\n  minResponses: number;\n  minSampleSize: number;\n}\n\nexport interface AggregatorFetchUpdateIxParams extends CommonOptions {\n  solanaRPCUrl?: string;\n  crossbarUrl?: string;\n  crossbarClient?: CrossbarClient;\n\n  // If passed in, Aptos Aggregator load can be skipped\n  feedConfigs?: AggregatorConfigs;\n\n  // If passed in, Aptos Queue load can be skipped\n  queue?: Queue;\n\n  // If passed in, update will be condensed into a single tx returned\n  getUpdateTx?: boolean;\n\n}\n\nexport interface CurrentResult {\n  maxResult: BN;\n  maxTimestamp: number;\n  mean: BN;\n  minResult: BN;\n  minTimestamp: number;\n  range: BN;\n  result: BN;\n  stdev: BN;\n}\n\nexport interface Update {\n  oracle: string;\n  value: BN;\n  timestamp: number;\n}\n\nexport interface AggregatorData {\n  address: string;\n  authority: string;\n  createdAt: number;\n  currentResult: CurrentResult;\n  feedHash: string;\n  maxStalenessSeconds: number;\n  maxVariance: number;\n  minResponses: number;\n  minSampleSize: number;\n  name: string;\n  queue: string;\n  updateState: {\n    currIdx: number;\n    results: Update[];\n  };\n}\n\nexport class Aggregator {\n  public crossbarClient?: CrossbarClient;\n  public feedHash?: string;\n\n  constructor(readonly client: SwitchboardClient, readonly address: string) {}\n\n  public static async initTx(\n    client: SwitchboardClient,\n    sender: string,\n    options: AggregatorInitParams\n  ): Promise<SimpleTransaction> {\n    const { switchboardAddress, oracleQueue } = await client.fetchState(\n      options\n    );\n\n    const transaction = await client.aptos.transaction.build.simple({\n      sender,\n      data: {\n        function: `${switchboardAddress}::aggregator_init_action::run`,\n        functionArguments: [\n          oracleQueue,\n          options.name,\n          Array.from(Buffer.from(options.feedHash.slice(2), \"hex\")),\n          options.minSampleSize,\n          options.maxStalenessSeconds,\n          options.maxVariance,\n          options.minResponses,\n        ],\n      },\n    });\n\n    return transaction;\n  }\n\n  /**\n   * Set configs for the Aggregator\n   * @param tx - Transaction\n   * @param options - AggregatorConfigParams\n   */\n  public async setConfigsTx(\n    sender: string,\n    options: AggregatorConfigParams\n  ): Promise<SimpleTransaction> {\n    const { switchboardAddress } = await this.client.fetchState(options);\n\n    const transaction = await this.client.aptos.transaction.build.simple({\n      sender,\n      data: {\n        function: `${switchboardAddress}::aggregator_set_configs_action::run`,\n        functionArguments: [\n          this.address,\n          options.name,\n          Array.from(Buffer.from(options.feedHash.slice(2), \"hex\")),\n          options.minSampleSize,\n          options.maxStalenessSeconds,\n          options.maxVariance,\n          options.minResponses,\n        ],\n      },\n    });\n\n    return transaction;\n  }\n\n  /**\n   * Set the feed authority\n   * @param tx - Transaction\n   * @param options - AggregatorSetAuthorityParams\n   */\n  public async setAuthorityTx(\n    options: AggregatorSetAuthorityParams\n  ): Promise<SimpleTransaction> {\n    const { switchboardAddress } = await this.client.fetchState(options);\n\n    const transaction = await this.client.aptos.transaction.build.simple({\n      sender: options.newAuthority,\n      data: {\n        function: `${switchboardAddress}::aggregator_set_authority_action::run`,\n        functionArguments: [this.address, options.newAuthority],\n      },\n    });\n\n    return transaction;\n  }\n\n  /**\n   * Fetch the update transaction\n   * @param sender - Sender\n   * @param options - AggregatorFetchUpdateIxParams\n   * @returns - FetchUpdateTxResponse\n   */\n  public async fetchUpdate(\n    sender: string,\n    options?: AggregatorFetchUpdateIxParams\n  ): Promise<{\n    responses: FeedEvalResponse[];\n    failures: string[];\n    updates: number[][];\n    updateTx: SimpleTransaction;\n  }> {\n    const { switchboardAddress } = await this.client.fetchState(options);\n\n    let oracleQueue: string;\n\n    // get the feed configs if we need them / they aren't passed in\n    let feedConfigs = options?.feedConfigs;\n    if (!feedConfigs) {\n      const aggregatorData = await this.loadData();\n      oracleQueue = aggregatorData.queue;\n      feedConfigs = {\n        minSampleSize: aggregatorData.minSampleSize,\n        feedHash: aggregatorData.feedHash,\n        maxVariance: aggregatorData.maxVariance,\n        minResponses: aggregatorData.minResponses,\n      };\n    }\n\n    if (!oracleQueue) {\n      throw new Error(\"[fetchUpdateTx]: ORACLE QUEUE NOT FOUND\");\n    }\n\n    // get the queue from cache\n    let aptosQueue = aptosQueueCache.get(oracleQueue);\n    if (!aptosQueue) {\n      const queue = await new Queue(this.client, oracleQueue).loadData();\n      aptosQueueCache.set(oracleQueue, queue);\n      aptosQueue = queue;\n    }\n\n    console.log(aptosQueue);\n\n    // load the solana queue from cache or fetch it\n    let solanaQueue: SolanaQueue;\n    if (aptosQueue.queueKey == ON_DEMAND_MAINNET_QUEUE.toBase58()) {\n      solanaQueue = solanaProgramCache.get(ON_DEMAND_MAINNET_QUEUE.toBase58());\n      if (!solanaQueue) {\n        solanaQueue = await getDefaultQueue(options?.solanaRPCUrl);\n        solanaProgramCache.set(ON_DEMAND_MAINNET_QUEUE.toBase58(), solanaQueue);\n      }\n    } else if (aptosQueue.queueKey == ON_DEMAND_DEVNET_QUEUE.toBase58()) {\n      solanaQueue = solanaProgramCache.get(ON_DEMAND_DEVNET_QUEUE.toBase58());\n      if (!solanaQueue) {\n        solanaQueue = await getDefaultDevnetQueue(options?.solanaRPCUrl);\n        solanaProgramCache.set(ON_DEMAND_DEVNET_QUEUE.toBase58(), solanaQueue);\n      }\n    } else {\n      throw new Error(\"[fetchUpdateTx]: QUEUE NOT FOUND\");\n    }\n\n    // fail out if we can't load the queue\n    if (!solanaQueue) {\n      throw new Error(\n        `Could not load the Switchboard Queue - Queue pubkey: ${aptosQueue.queueKey}`\n      );\n    }\n\n    // get the crossbar client\n    const crossbarClient =\n      options?.crossbarClient ??\n      new CrossbarClient(\n        options?.crossbarUrl ?? \"https://crossbar.switchboard.xyz\"\n      );\n\n    // fetch the jobs\n    const jobs: OracleJob[] = await crossbarClient\n      .fetch(feedConfigs.feedHash)\n      .then((res) => res.jobs.map((job) => OracleJob.fromObject(job)));\n\n      \n    const fetchUpdateData = async () => {\n\n      // fetch the signatures\n      const { responses, failures } = await solanaQueue.fetchSignatures({\n        jobs,\n\n        // Make this more granular in the canonical fetch signatures (within @switchboard-xyz/on-demand)\n        maxVariance: Math.floor(feedConfigs.maxVariance / 1e9),\n        minResponses: feedConfigs.minResponses,\n        numSignatures: feedConfigs.minSampleSize,\n\n        // blockhash checks aren't possible yet on SUI\n        recentHash: bs58.encode(new Uint8Array(32)),\n        useTimestamp: true,\n      });\n\n      // filter out responses that don't have available oracles\n      const validOracles = new Set(\n        aptosQueue.existingOracles.map((o) => o.oracleKey)\n      );\n\n      // filter out responses that don't have available oracles\n      const validResponses = responses.filter((r) => {\n        return validOracles.has(bs58.encode(Buffer.from(r.oracle_pubkey, \"hex\")));\n      });\n\n      // if we have no valid responses (or not enough), fail out\n      if (\n        !validResponses.length ||\n        validResponses.length < feedConfigs.minSampleSize\n      ) {\n        // maybe retry by recursing into the same function / add a retry count\n        throw new Error(\"Not enough valid oracle responses.\");\n      }\n\n      // update strings to build the single update string\n      const updates = [];\n\n      // map the responses into the tx\n      for (const response of validResponses) {\n        const oracle = aptosQueue.existingOracles.find(\n          (o) =>\n            o.oracleKey == bs58.encode(Buffer.from(response.oracle_pubkey, \"hex\"))\n        );\n\n        if (!oracle) {\n          return;\n        }\n\n        // Get the data from the response\n        const signature = Array.from(Buffer.from(response.signature, \"base64\"));\n        signature.push(response.recovery_id);\n        const aggregatorAddress = this.address;\n        const timestamp = response.timestamp;\n        const value = response.success_value;\n\n        // build update array\n        const updateBytes = [];\n       \n        // discriminator\n        updateBytes.push(1);\n\n        // format the feed address\n        const feedAddress = Array.from(Buffer.from(aggregatorAddress.startsWith(\"0x\") ? aggregatorAddress.slice(2) : aggregatorAddress, \"hex\"));\n        if (feedAddress.length < 32) {\n          feedAddress.unshift(0);\n        }\n\n        // push feed address\n        updateBytes.push(\n          ...feedAddress\n        );\n\n        // push value\n        updateBytes.push(...Array.from(this.i128ToUint8Array(BigInt(value))));\n\n        // push r\n        updateBytes.push(...signature.slice(0, 32));\n\n        // push s\n        updateBytes.push(...signature.slice(32, 64));\n\n        // push v\n        updateBytes.push(signature[64]);\n\n        // push block number (zeroed out for now - bytes32 0)\n        updateBytes.push(...Array(8).fill(0));\n\n        // push timestamp\n        const timestampBuffer = Buffer.alloc(8);\n        timestampBuffer.writeBigInt64BE(BigInt(timestamp), 0);\n        updateBytes.push(...Array.from(timestampBuffer));\n\n        // push oracle address\n        updateBytes.push(\n          ...Array.from(bs58.decode(oracle.oracleKey))\n        );\n\n        // push the update bytes\n        updates.push(updateBytes);\n      }\n\n      // get the transaction for update\n      const updateTx = await this.client.aptos.transaction.build.simple({\n        sender,\n        data: {\n          function: `${switchboardAddress}::update_action::run`,\n          functionArguments: [updates],\n          typeArguments: [APTOS_COIN],\n        },\n        withFeePayer: true,\n      });\n\n      return { responses, failures, updates, updateTx };\n    }\n\n    // try to fetch the update data (retry up to 3 times)\n    let fetchUpdateDataRetries = 0;\n    let fetchUpdateDataResponse: {\n      responses: FeedEvalResponse[];\n      failures: string[];\n      updates: number[][];\n      updateTx: SimpleTransaction;\n    };\n\n    // try to fetch the update data (retry up to 5 times)\n    while (fetchUpdateDataRetries < 5) {\n      try {\n        fetchUpdateDataResponse = await fetchUpdateData();\n        break;\n      } catch (e) {\n        fetchUpdateDataRetries++;\n        console.log(\"Failed to fetch update data, retrying...\");\n      }\n    }\n\n    // fail out if we can't fetch the update data\n    if (!fetchUpdateDataResponse) {\n      throw new Error(\"Failed to fetch update data\");\n    }\n\n    // return the response\n    return fetchUpdateDataResponse;\n  }\n\n  public static parseAggregatorData(resource: any): AggregatorData {\n    const data: AggregatorData = {\n      address: resource.aggregator_address,\n      authority: resource.authority,\n      createdAt: parseInt(resource.created_at),\n      currentResult: {\n        maxResult: new BN(resource.current_result.max_result.value).mul(\n          new BN(resource.current_result.max_result.neg ? -1 : 1)\n        ),\n        maxTimestamp: parseInt(resource.current_result.max_timestamp),\n        mean: new BN(resource.current_result.mean.value).mul(\n          new BN(resource.current_result.mean.neg ? -1 : 1)\n        ),\n        minResult: new BN(resource.current_result.min_result.value).mul(\n          new BN(resource.current_result.min_result.neg ? -1 : 1)\n        ),\n        minTimestamp: parseInt(resource.current_result.min_timestamp),\n        range: new BN(resource.current_result.range.value).mul(\n          new BN(resource.current_result.range.neg ? -1 : 1)\n        ),\n        result: new BN(resource.current_result.result.value).mul(\n          new BN(resource.current_result.result.neg ? -1 : 1)\n        ),\n        stdev: new BN(resource.current_result.stdev.value).mul(\n          new BN(resource.current_result.stdev.neg ? -1 : 1)\n        ),\n      },\n      feedHash: resource.feed_hash,\n      maxStalenessSeconds: parseInt(resource.max_staleness_seconds),\n      maxVariance: parseInt(resource.max_variance),\n      minResponses: parseInt(resource.min_responses),\n      minSampleSize: parseInt(resource.min_sample_size),\n      name: resource.name,\n      queue: resource.queue,\n      updateState: {\n        currIdx: parseInt(resource.update_state.curr_idx),\n        results: resource.update_state.results.map((r: any) => {\n          const oracle = r.oracle;\n          const value = new BN(r.result.value).mul(r.result.neg ? new BN(-1) : new BN(1));\n          const timestamp = parseInt(r.timestamp);\n          return {\n            oracle,\n            value,\n            timestamp,\n          };\n        }),\n      },\n    };\n\n    return data;\n  }\n\n  /**\n   * Get the feed data object\n   */\n  public async loadData(): Promise<AggregatorData> {\n    const { switchboardAddress } = await this.client.fetchState();\n    const resources = await this.client.aptos.view({\n      payload: {\n        function: `${switchboardAddress}::aggregator::view_aggregator`,\n        functionArguments: [this.address],\n      },\n    });\n    const resource = resources[0] as any;\n    \n    // return the data object\n    return Aggregator.parseAggregatorData(resource);\n  }\n\n  /**\n   * Load all feeds\n   */\n  public static async loadAllFeeds(\n    switchboardClient: SwitchboardClient,\n  ) {\n    const { switchboardAddress, oracleQueue } = await switchboardClient.fetchState();\n    const resourcesResponse = await switchboardClient.aptos.view({\n      payload: {\n        function: `${switchboardAddress}::aggregator::view_queue_aggregators`,\n        functionArguments: [oracleQueue],\n      },\n    });\n    const resources = resourcesResponse[0] as any;\n    const aggregators: AggregatorData[] = resources.map((resource: any) => this.parseAggregatorData(resource));\n    return aggregators;\n  }\n\n  private i128ToUint8Array(value: bigint): Uint8Array {\n\n    // Prepare an array of 16 bytes (128 bits).\n    const result = new Uint8Array(16);\n\n    // Convert the absolute value to Big-Endian bytes\n    let absValue = value < 0 ? -value : value;\n    for (let i = 15; i >= 0; i--) {\n      result[i] = Number(absValue & BigInt(0xFF));\n      absValue = absValue >> BigInt(8);\n    }\n\n    // If it's a negative number, apply two's complement\n    if (value < 0) {\n      for (let i = 0; i < 16; i++) {\n        result[i] = ~result[i] & 0xFF;\n      }\n\n      // Add one to complete the two's complement\n      for (let i = 15; i >= 0; i--) {\n        result[i] = (result[i] + 1) & 0xFF;\n        if (result[i] !== 0) break; // Stop if there was no overflow\n      }\n    }\n\n    return result;\n  }\n}\n\n// Alias Aggregator to PullFeed\nexport const PullFeed = Aggregator;\n"]}